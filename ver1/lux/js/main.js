var slideCaption = {
	"0" : {"img" : "img/word1.png", "cp" : "我的新世代關鍵字", "h3" : "靓裝美學，熱情奔放令人目不轉睛！", "p" : "LUXGEN U6 TURBO以自信勾勒的動感流線，放大了每一吋的魅力強度，對斜背美型設計的目不轉睛，只是世人對內心渴望獻上極度讚嘆的注目禮。新世代品味之作，動靚皆美到無與倫比。"},
	"1" : {"img" : "img/word2.png", "cp" : "我的新世代關鍵字", "h3" : "酷放自如，寬適風格就是我的大世界！", "p" : "空間釋放了靈魂的寬度，座椅撫慰了身體的重量，讓你能自在滿足的和自己的心從容對話、恣意微笑，讓自我與LUXGEN U6 TURBO相遇在能包容一切美好的世界裡。"},
	"2" : {"img" : "img/word3.png", "cp" : "我的新世代關鍵字", "h3" : "幻境百變，自由與生活合而為一！", "p" : "在自由的領域裡，彈性是不可或缺的靈感。LUXGEN U6 TURBO在每個隨心所欲的角落裡，隱藏著不露痕跡的細膩巧思，預先設想每一個人的空間感受，讓多變空間幻化為一種獨特魅力。"},
	"3" : {"img" : "img/word4.png", "cp" : "我的新世代關鍵字", "h3" : "極夯行控，智慧的城市漫遊者！", "p" : "聲控行動助理讓溝通有了全新的表達方式，聲音與觸覺變得單純而熱切，跟著未來在城市移動，體會最夯的演繹表情，當自信逐漸在臉上滿溢時，我們赫然瞭解，熱情聲控的行動智慧，已將行車間的各項需求，完美打理。"},
	"4" : {"img" : "img/word5.png", "cp" : "我的新世代關鍵字", "h3" : "潮流前瞻，從縝密思維中創見未來！", "p" : "透過智慧與工藝的縝密結合，將下一秒所預見的未來投射在前瞻思維的進化之中，所有安心的能量，已然存在於面面俱到的安全細節裡。透過智慧與工藝的縝密結合，將下一秒所預見的未來投射在前瞻思維的進化之中，所有安心的能量，已然存在於面面俱到的安全細節裡。"},
	"5" : {"img" : "img/word6.png", "cp" : "我的新世代關鍵字", "h3" : "讚嘆移動，品質嚴格限定！", "p" : "全鋁合金打造的全新1.8/2.0L VVT TURBO引擎，兼具輕量、高效率兩大優勢，於2,400rpm便可將扭力全部釋放並持續到4,000 rpm，讓車主盡情地享受渦輪引擎的爆發力。"}
};

var ShareContent = {
    "0" : {"link" : "http://event.luxgen-motor.com.tw/u6_turbo/index.html", "name" : "LUXGEN U6 TURBO 新世代SUV關鍵字票選", "caption" : "", "picture" : "http://event.luxgen-motor.com.tw/u6_turbo/img/share/01.jpg", "description" : "屬於我的新世代關鍵字是 [ 靚 ] ，那你的呢？  現在只要投下你心中的新世代關鍵字，即可抽北投春天酒店溫泉饗宴雙人票（含套餐及泡湯），來店試乘U6 TURBO還可獲贈限量好禮！"},
    "1" : {"link" : "http://event.luxgen-motor.com.tw/u6_turbo/index.html", "name" : "LUXGEN U6 TURBO 新世代SUV關鍵字票選", "caption" : "", "picture" : "http://event.luxgen-motor.com.tw/u6_turbo/img/share/02.jpg", "description" : "屬於我的新世代關鍵字是 [ 酷 ] ，那你的呢？  現在只要投下你心中的新世代關鍵字，即可抽北投春天酒店溫泉饗宴雙人票（含套餐及泡湯），來店試乘U6 TURBO還可獲贈限量好禮！"},
    "2" : {"link" : "http://event.luxgen-motor.com.tw/u6_turbo/index.html", "name" : "LUXGEN U6 TURBO 新世代SUV關鍵字票選", "caption" : "", "picture" : "http://event.luxgen-motor.com.tw/u6_turbo/img/share/03.jpg", "description" : "屬於我的新世代關鍵字是 [ 幻 ] ，那你的呢？  現在只要投下你心中的新世代關鍵字，即可抽北投春天酒店溫泉饗宴雙人票（含套餐及泡湯），來店試乘U6 TURBO還可獲贈限量好禮！"},
    "3" : {"link" : "http://event.luxgen-motor.com.tw/u6_turbo/index.html", "name" : "LUXGEN U6 TURBO 新世代SUV關鍵字票選", "caption" : "", "picture" : "http://event.luxgen-motor.com.tw/u6_turbo/img/share/04.jpg", "description" : "屬於我的新世代關鍵字是 [ 夯 ] ，那你的呢？  現在只要投下你心中的新世代關鍵字，即可抽北投春天酒店溫泉饗宴雙人票（含套餐及泡湯），來店試乘U6 TURBO還可獲贈限量好禮！"},
    "4" : {"link" : "http://event.luxgen-motor.com.tw/u6_turbo/index.html", "name" : "LUXGEN U6 TURBO 新世代SUV關鍵字票選", "caption" : "", "picture" : "http://event.luxgen-motor.com.tw/u6_turbo/img/share/05.jpg", "description" : "屬於我的新世代關鍵字是 [ 潮 ] ，那你的呢？  現在只要投下你心中的新世代關鍵字，即可抽北投春天酒店溫泉饗宴雙人票（含套餐及泡湯），來店試乘U6 TURBO還可獲贈限量好禮！"},
    "5" : {"link" : "http://event.luxgen-motor.com.tw/u6_turbo/index.html", "name" : "LUXGEN U6 TURBO 新世代SUV關鍵字票選", "caption" : "", "picture" : "http://event.luxgen-motor.com.tw/u6_turbo/img/share/06.jpg", "description" : "屬於我的新世代關鍵字是 [ 讚 ] ，那你的呢？  現在只要投下你心中的新世代關鍵字，即可抽北投春天酒店溫泉饗宴雙人票（含套餐及泡湯），來店試乘U6 TURBO還可獲贈限量好禮！"}
};



var textUnitHeight;
var _ajaxStart = false;
var currentIndex = 0;
var fb_id = '', fb_name = '', fb_email = '';
var randomDuration = 3500;
//loader finish
window.finishPreload = function(){
	// console.log(jQuery);
	$('#pace-shade').fadeOut(600);
}
//end loader finish

jQuery(document).ready(function(jQuery) {

	$(document).ajaxStart(function(){
        _ajaxStart = true;
    }).ajaxSend(function(){
    }).ajaxStop(function(){
        _ajaxStart = false;
    }).ajaxSuccess(function(){
        _ajaxStart = false;
    }).ajaxError(function(){
        _ajaxStart = false;
    }).ajaxComplete(function(){
        _ajaxStart = false;
    });

	jQuery("#homeSec").backstretch("img/homeBg.jpg");

	//end backstretch
	var winH = $( window ).height();
	if (winH<680) {
	    $('#u6Turbo').addClass('short');
	}
	$( window ).resize(function() {
	    winH = $( window ).height();
	    if (winH<680) {
	        $('#u6Turbo').addClass('short');
	    }else{
	        $('#u6Turbo').removeClass('short');
	    }
	});

    var slotInterval = window.setInterval(startSlot, randomDuration);
    // window.setTimeout(function(){
    //     console.log('settimeout');
    // },1700);

	$('.textWrap .flytext').each(function(){
	    var ctr;
	    var thisLi = $(this);
	    var moveupDist;

	    appendWords(thisLi);
	    textUnitHeight = $('.textUnit').eq(0).find('img').eq(0).css('height');
	    $('.textUnit').eq(0).find('img').load(function(){
	    	textUnitHeight = $('.textUnit').eq(0).find('img').eq(0).css('height');
	    	textUnitWidth = $('.textUnit').eq(0).find('img').eq(0).css('width');
	    	// console.log($('.textUnit').eq(0).find('img').eq(0).height());
	    	$('.textUnit').css('height', textUnitHeight);
			$('.textUnit').css('width', textUnitWidth);
	    	// var moveupDist = -parseInt(textUnitHeight)*15;
		    // var innerSecWidth = $('#homeSec .secInner').width();
		    var moveupDist = -parseInt(textUnitHeight)*15;
		    // console.log(moveupDist);
		    // console.log(parseInt(textUnitHeight));

		    thisLi.find('div').delay(600).animate({
		        marginTop: [moveupDist, 'linear']
		    }, thisLi.data('duration'), function(){
		        appendWords(thisLi);
		    });

	    });

	});

    // var winH = $(window).height(); 
    // if (winH < 680) {
    //     $('#homeSec h2').addClass('short');
    // }
    // $(window).resize(function(){
    //     winH = $(window).height();
    //     if (winH < 680) {
    //         $('#homeSec h2').addClass('short');
    //     }else{
    //         $('#homeSec h2').removeClass('short');
    //     }
    // });
        
	$('#goToSecond').click(function(){
		// e.preventDefault();
		checkLoginStatus();
		return false;
	});


	$("#fbShare").click(function(){
        FB.ui({
            method: 'feed',
            // link: ShareContent[currentIndex].link,
            name: ShareContent[currentIndex].name,
            caption: ShareContent[currentIndex].caption,
            picture: ShareContent[currentIndex].picture,
            description: ShareContent[currentIndex].description
        }, function(response){
            if ( response == null ) {
                // console.log('cancel');
            } else {
                window.setTimeout(function(){
                    $.magnificPopup.open({
                        items: {
                            src: $('#u6Form')
                        },
                        type: 'inline'
                    }, 0);
                }, 1);
                // thisView.sec2away();
            }
        });
    });

	$("#formSubmit").click(function(){

        if (_ajaxStart == false) {
            $.ajax({
                url: "http://event.luxgen-motor.com.tw/u6_turbo/httphandler/share.ashx",
                type: "post",
                data: "fbid="      + fb_id
                    + "&name="     + $("#name").val() 
                    + "&phone="    + $("#phone").val() 
                    // + "&email="    + fb_email 
                    + "&city="     + (($("#city").val() == null) ? "" : $("#city").val())
                    + "&cityarea=" + (($("#cityarea").val() == null) ? "" : $("#cityarea").val())
                    + "&address="  + $("#address").val() 
                    + "&choice="   + currentIndex
                    + "&confirm="  + $("input[name='termAgree']:checked").val(),
                dataType: "json",
                success: function (data) {
                    // console.log(data);
                    if (data.ErrorString != "") {
                        alert(data.ErrorString);
                    } else {

                        $.magnificPopup.close();
                        window.setTimeout(function(){
                            $.magnificPopup.open({
                                items: {
                                    src: $('#success')
                                },
                                type: 'inline',
                                callbacks: {
                                	afterClose: function() {
                                		window.open('http://www.luxgen-motor.com.tw/u6_Turbo.html');
                                	}
                                }
                            }, 0);
                        }, 1);

                    }
                },
                error: function (err) {
                    // alert("Ooos! " + err);
                    alert("請重新選擇您喜愛的關鍵字");
                    $.magnificPopup.close();

                }
            });
        }
    });

	$('#pollGroup li').each(function(index, value){
        $(this).click(function(){
            if (index == $("#pollResultRS").data('royalSlider').currSlideId) {
                $("#pollResultRS").data('royalSlider').goTo(index + 6);
            } else {
                $("#pollResultRS").data('royalSlider').goTo(index);
            }
            $('#pollGroup li.active').removeClass('active');
            $(this).addClass('active');
        });
    });

    

function startSlot() {
    
    var movingIndex = Math.floor(Math.random()*6);

    var x = [0,1,2,3,4,5];
    var randomSelectWord = getRandomSubarray(x,2);
    // console.log(randomSelectWord);
    runAword(randomSelectWord[0], 100, 1200);
    runAword(randomSelectWord[1], 700, 800);

    randomDuration = Math.round(Math.random()*1000) + 3000;
    // console.log('startslot'+randomDuration);
}

function runAword(movingIndex, t1, t2) {
    
    var textMoveDist = '-=' + parseInt(textUnitHeight)*16; 
    console.log('test '+ $('.textWrap .flytext').eq(movingIndex).find('div').css('marginTop'));
    console.log('test2 '+ textMoveDist);
    $('.textWrap .flytext').eq(movingIndex).find('div').delay(t1).animate({
        marginTop: [textMoveDist, 'linear']
    }, t2, function() {
        
        appendWords($('.textWrap .flytext').eq(movingIndex));
        // for (var j = 0; j < 16; j++ ) {
        //     $('.textWrap .flytext').eq(movingIndex).find('img').eq(j).remove();
        // }
        // var textMoveJump = '+=' + parseInt(textUnitHeight)*16;
        // $('.textWrap .flytext').eq(movingIndex).find('div').css('marginTop', textMoveJump);
        
    });

} 

function appendWords(wordsOuter) {
    var randomWords = '';
    for (var i = 0; i < 15; i++ ) {
        ctr = Math.floor(Math.random()*6+1);
        randomWords = randomWords + '<img src="img/word' + ctr + '.png" alt="word">';
    }
    randomWords = randomWords + '<img src="img/word' + wordsOuter.data('word') + '.png" alt="word">';
    wordsOuter.find('div').append(randomWords);
    
    // $('.textUnit').eq(0).find('img').load(function(){
    // 	textUnitHeight = $('.textUnit').eq(0).find('img').eq(0).css('height');
    // 	console.log(parseInt(textUnitHeight));
    // });
}

function getRandomSubarray(arr, size) {
    var shuffled = arr.slice(0), i = arr.length, temp, index;
    while (i--) {
        index = Math.floor(i * Math.random());
        temp = shuffled[index];
        shuffled[index] = shuffled[i];
        shuffled[i] = temp;
    }
    return shuffled.slice(0, size);
}

function isEmpty(obj) {
    for (var prop in obj) {
        if (obj.hasOwnProperty(prop))
            return false;
    }
    return true;
}

window.fbAsyncInit = function() {
    FB.init({
        appId      : '170582636468453',
        // channelUrl : '//yourdomain.com/channel.html',
        status     : true,
        cookie     : true,
        xfbml      : true
    });

};
    // FB.getLoginStatus(checkLoginStatus);

function checkLoginStatus(response) {
    FB.getLoginStatus(function(response) {
        if (response.status === 'connected') {
            // console.log('user connected' + response.authResponse.userID);
            uid = response.authResponse.userID;
            var accessToken = response.authResponse.accessToken;

            FB.api({
                method: 'fql.query',
                query: 'SELECT uid, name, email, pic_big FROM user WHERE uid = ' + uid
            }, function(rep){
                if (!isEmpty(rep)) {
                    fb_id    = rep[0].uid;
                    fb_name  = rep[0].name;
                    fb_email = rep[0].email;
                }
                // console.log(fb_id);
                // console.log(fb_name);
                // console.log(fb_email);
                sec1away();
            });

        } else if (response.status === 'not_authorized') {
            // console.log('user not authorize');
            fbLogin();
        } else {
            // the user isn't logged in to Facebook.
            // console.log('user not login');
            fbLogin();
        }
    });
    return false;
}

function fbLogin() {

    FB.login(function(response){
        
        if (response.authResponse) {
            
            var uid = response.authResponse.userID;
            var fbaccess_token = response.authResponse.accessToken;

            // console.log('login ' + uid);
            // console.log(fbaccess_token);

            FB.api({
                method: 'fql.query',
                query: 'SELECT uid, name, email, pic_big FROM user WHERE uid = ' + uid
            }, function(rep){
                if (!isEmpty(rep)) {
                    fb_id    = rep[0].uid;
                    fb_name  = rep[0].name;
                    fb_email = rep[0].email;
                    if (_ajaxStart == false) {
                        $.ajax({
                            url: "http://event.luxgen-motor.com.tw/u6_turbo/httphandler/connect.ashx",
                            type: "post",
                            data: "name=" + fb_name + "&fbid=" + fb_id + "&email=" + fb_email,
                            dataType: "json",
                            success: function (data) {
                                // console.log(data);
                                if (data.ErrorString == "error") {
                                    alert("請重新登入 Facebook");
                                } else {
                                    sec1away();
                                }
                            },
                            error: function (err) {
                                // alert("Ooos! " + err);
                                alert("請重新登入");

                            }
                        });
                    }
                }
            });

        } else {
            // console.log('User cancelled login or did not fully authorize.');
        }
    }, {scope: 'email,user_likes'});

}

function sec1away() {
            
    // e.preventDefault();
    var flyIndex = 0;
    var thisView = this;
    
    var effect = function(index) {
        // console.log($('.textUnit').eq(index));
        var leftValue = 0;
        $('#textPoll').css('top', '45%').animate({
            top: ['27%', /*'easeOutQuad'*/'linear']
        }, 700);
        $('#textPoll p').animate({
            marginLeft: ['7.14%', 'linear']
        }, 700);
        switch (index) {
            case 0: 
                $('.textUnit').eq(index).animate({
                    // marginTop: ['-20%', 'swing'],
                    left: ['7.14%', 'linear']
                }, 700);
                break;
            case 1:
                $('.textUnit').eq(index).animate({
                    // marginTop: ['-20%', 'swing'],
                    left: ['21.42%', 'linear']
                }, 700);
                break;
            case 2:
                $('.textUnit').eq(index).animate({
                    // marginTop: ['-20%', 'swing'],
                    left: ['35.7%', 'linear']
                }, 700);
                break;
            case 3:
                $('.textUnit').eq(index).fadeOut();
                break;
            case 4: 
                $('.textUnit').eq(index).animate({
                    // marginTop: ['-20%', 'swing'],
                    left: ['49.98%', 'linear']
                }, 700);
                break;
            case 5:
                $('.textUnit').eq(index).animate({
                    // marginTop: ['-20%', 'swing'],
                    left: ['64.26%', 'linear']
                }, 700);
                break;
            case 6:
                $('.textUnit').eq(index).animate({
                    // marginTop: ['-20%', 'swing'],
                    left: ['78.54%', 'linear']
                }, 700);
                break;
        }
        
    };
    for (var k = 0; k < 7; k++ ) {
        effect(k);
    }
    
    sec2flyin();
    
}

function sec2flyin() {

    var flyinIndex = 0;
    window.clearInterval(slotInterval);

    $('.textUnit').addClass('hoverBorder').wrap('<a href="#"></a>');
    $("#homeSec").backstretch([
        "img/selectionBg.jpg"
    ], {fade: 600});

    // console.log('sec2flyin' + $('.textUnit'));

    $('#homeSec .key2').fadeOut();
    $('#homeSec .key3').fadeIn();
    $('#homeCtp').fadeOut();

    $('.flytext').click(function(){
        // console.log('click id ' + $(this).data('word') );
        // var clickedWordId = Math.random() < 0.5 ? ($(this).data('word')-1) : ($(this).data('word')+5);
        var clickedWordId = $(this).data('word')-1;
        sec2away(clickedWordId);
    });
    
}

function sec2away(clickedWordId) {
            
    var flyOutIdex = 0;
    var homeSecHeight = $('#homeSec').height();

    $('#homeSec').animate({
        marginTop: [-homeSecHeight, 'linear']
    },700, function(){
        $(this).css('display','none');
    });

    $('#pollResultSec').fadeIn(700);

    $('#pollResultRS').royalSlider({
        loop: true,
        controlNavigation: 'none',
        imageScaleMode: 'fill',
        slidesSpacing:0,
        transitionType:'move',
        startSlideId: clickedWordId
    });

    var slider = $("#pollResultRS").data('royalSlider');//declare slider
    var currentSlide = slider.currSlideId;
    var thumbIndex = currentSlide % 6;
    var rsThumbs = $('#pollGroup li');
    var rsCaptions = $('.slideCpt');

    currentIndex = thumbIndex;

    $(".rsDescUnit.title div").remove();
    $(".rsDescUnit.title").append(
        '<div class="slideCpt">' + 
        '<h2><img src="' + slideCaption[thumbIndex].img + '" alt=""></h2>' + 
        '<p class="cp">' + slideCaption[thumbIndex].cp + '</p>' + 
        '<h3>' + slideCaption[thumbIndex].h3 + '</h3>' + 
        '<p>' + slideCaption[thumbIndex].p + '</p>' +
        '</div>'
    );

    $('#pollGroup li.active').removeClass('active');
    $('#pollGroup li').eq(thumbIndex).addClass('active');

    $("#pollResultRS").data('royalSlider').ev.on('rsAfterSlideChange', function(event) {
        var ndx = this.currSlideId % 6;
        $('#pollGroup li.active').removeClass('active');
        $('#pollGroup li').eq(ndx).addClass('active');
    });

}


});